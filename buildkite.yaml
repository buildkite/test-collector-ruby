steps:
  - label: ":rspec: Tests :ruby: 3.3-rc"
    command:
      - "ls -la /usr/local/bundle"
      - "bundle"
      - "ls -la /usr/local/bundle"
      - "bundle exec rake"
    plugins:
      - docker#v5.9.0:
          image: "ruby:3.3-rc"
          volumes:
            - "./bundle-cache:/usr/local/bundle"
      - namespacelabs/nscache#v0.1:
          paths:
            - bundle-cache
    soft_fail: true
    agents:
      nsc-cache-tag: test-collector-ruby/3.3-rc
      # nsc-experimental-containerd-cache-tag: test-collector-ruby/container-cache
      nsc-experimental-containerd-cache-relative-path: containers

  - label: ":rspec: Tests :ruby: {{matrix}}"
    command:
      - "bundle"
      - "bundle exec rake"
    plugins:
      - docker#v5.9.0:
          image: "ruby:{{matrix}}"
          volumes:
            - "./bundle-cache:/usr/local/bundle"
      - namespacelabs/nscache#v0.1:
          paths:
            - bundle-cache
    matrix:
      - "latest"
      - "3.2"
      - "3.1"
      - "3.0"
      - "2.7"
    agents:
      nsc-cache-tag: test-collector-ruby/{{matrix}}
      # nsc-experimental-containerd-cache-tag: test-collector-ruby/container-cache
      nsc-experimental-containerd-cache-relative-path: containers

  - group: ":rspec: Legacy Ruby :ruby:"
    steps:
      - label: ":rspec: Tests :ruby: {{matrix}}"
        command:
          - "gem install bundler:2.3.25"
          - "bundle"
          - "bundle exec rake"
        plugins:
          - docker#v5.9.0:
              # Images for older Ruby versions aren't available on AWS ECR
              # so fall back to Docker Hub
              image: "ruby:{{matrix}}"
              volumes:
                - "./bundle-cache:/usr/local/bundle"
          - namespacelabs/nscache#v0.1:
              paths:
                - bundle-cache
        matrix:
          - "2.6"
          - "2.5"
          - "2.4"
          - "2.3"
        agents:
          nsc-cache-tag: test-collector-ruby/{{matrix}}
          # nsc-experimental-containerd-cache-tag: test-collector-ruby/container-cache
          nsc-experimental-containerd-cache-relative-path: containers
